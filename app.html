<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ë≤°ÂãôÁ∏ΩÁÆ° V8</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .no-select { user-select: none; -webkit-user-select: none; }
        input, select, textarea { font-size: 16px !important; }
        
        /* Ëá™ÂÆöÁæ©ÊªæÂãïÊ¢ùÈö±Ëóè‰ΩÜ‰øùÊåÅÂäüËÉΩ */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 no-select">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 1. ÂúñÁ§∫ÁµÑ‰ª∂ ---
        const IconWrapper = ({ children, className, onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>{children}</svg>
        );
        const Plus = (p) => <IconWrapper {...p}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconWrapper>;
        const ListIcon = (p) => <IconWrapper {...p}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></IconWrapper>;
        const PieChart = (p) => <IconWrapper {...p}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></IconWrapper>;
        const Trash2 = (p) => <IconWrapper {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconWrapper>;
        const TrendingUp = (p) => <IconWrapper {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></IconWrapper>;
        const TrendingDown = (p) => <IconWrapper {...p}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></IconWrapper>;
        const ArrowRightLeft = (p) => <IconWrapper {...p}><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><path d="M4 4l5 5"></path></IconWrapper>;
        const Home = (p) => <IconWrapper {...p}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></IconWrapper>;
        const Wallet = (p) => <IconWrapper {...p}><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"></path><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"></path></IconWrapper>;
        const Building2 = (p) => <IconWrapper {...p}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"></path><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"></path><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"></path><path d="M10 6h4"></path><path d="M10 10h4"></path><path d="M10 14h4"></path><path d="M10 18h4"></path></IconWrapper>;
        const Landmark = (p) => <IconWrapper {...p}><line x1="3" y1="22" x2="21" y2="22"></line><line x1="6" y1="18" x2="6" y2="11"></line><line x1="10" y1="18" x2="10" y2="11"></line><line x1="14" y1="18" x2="14" y2="11"></line><line x1="18" y1="18" x2="18" y2="11"></line><polygon points="12 2 20 7 4 7"></polygon></IconWrapper>;
        const Download = (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></IconWrapper>;
        const Briefcase = (p) => <IconWrapper {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></IconWrapper>;

        // --- 2. Ë®≠ÂÆöÊ™î (Ë≥áÊñô) ---
        // Êñ∞Â¢û group Â±¨ÊÄßÔºå‰∏¶Âä†ÂÖ• company_pool
        const SHOPS = [
            // È∫ªÂ∞áÈ§®ÁµÑ
            { id: 'dalin', name: 'Â§ßÊûóÈ∫ªÂ∞á', type: 'business', group: 'mahjong', color: 'bg-blue-100 text-blue-800' },
            { id: 'bade', name: 'ÂÖ´Âæ∑È∫ªÂ∞á', type: 'business', group: 'mahjong', color: 'bg-indigo-100 text-indigo-800' },
            { id: 'guanyin', name: 'ËßÄÈü≥È∫ªÂ∞á', type: 'business', group: 'mahjong', color: 'bg-purple-100 text-purple-800' },
            { id: 'nankan', name: 'ÂçóÂ¥ÅÈ∫ªÂ∞á', type: 'business', group: 'mahjong', color: 'bg-pink-100 text-pink-800' },
            { id: 'yangmei', name: 'Ê•äÊ¢ÖÈ∫ªÂ∞á', type: 'business', group: 'mahjong', color: 'bg-rose-100 text-rose-800' },
            { id: 'zhonghe', name: '‰∏≠ÂíåÈ∫ªÂ∞á', type: 'business', group: 'mahjong', color: 'bg-orange-100 text-orange-800' },
            // ÈáéÈôåÁµÑ
            { id: 'yemo', name: 'ÈáéÈôåÈ§êÂª≥', type: 'business', group: 'yemo', color: 'bg-emerald-100 text-emerald-800' },
            // ÂÄã‰∫∫ËàáÁ∏ΩÁÆ°ÁµÑ
            { id: 'company_pool', name: 'ÂÖ¨Âè∏Á∏ΩÁÆ°', type: 'business', group: 'general', color: 'bg-gray-800 text-white' }, // Êñ∞Â¢ûÔºöËß£Ê±∫Ê∑∑Áî®ËΩâÂ∏≥Ê≠∏Â±¨
            { id: 'family', name: 'ÂÆ∂Â∫≠/ÂÄã‰∫∫', type: 'personal', group: 'general', color: 'bg-slate-200 text-slate-800' },
        ];

        const CATEGORIES = {
            business_expense: ['ÁßüÈáë', 'Á®ÖÈáë', 'ÈÄ≤Ë≤®/È£üÊùê', 'Ê∞¥ÈõªÁì¶ÊñØ', 'Âª£ÂëäË≤ª', '‰∫∫‰∫ãËñ™Ë≥á', 'Èõ∂Áî®ÈáëÈõúÊîØ', 'Ë®≠ÂÇôÁ∂≠‰øÆ', 'ÂÖ∂‰ªñ'],
            business_income: ['ÁáüÊ•≠Êî∂ÂÖ•', 'ÂÑ≤ÂÄºÂÖ•Â∏≥', 'ÂÖ∂‰ªñÊî∂ÂÖ•'],
            personal_expense: ['Â≠∏Ë≤ª', 'ÁîüÊ¥ªË≤ª', '‰øùÈö™Ë≤ª', '‰ø°Áî®Âç°Ë≤ª', 'Ë≥ºÁâ©', 'È§êË≤ª', '‰∫§ÈÄö', 'ÂÖ∂‰ªñ'],
            personal_income: ['Ëñ™Ë≥á', 'ÊäïË≥áÊî∂Áõä', 'Â∫óÈã™ÁõàÈ§òÊèêÈ†ò', 'ÂÖ∂‰ªñ'],
        };

        const ACCOUNTS = [
            // --- ÂÄã‰∫∫Â∏≥Êà∂Áæ§ ---
            { id: 'my_cash', name: 'ÁèæÈáë', type: 'personal' },
            { id: 'my_jkopay', name: 'Ë°óÂè£ÊîØ‰ªò', type: 'personal' },
            { id: 'my_ctbc', name: '‰∏≠Âúã‰ø°Ë®ó *96047', type: 'personal' },
            { id: 'my_huanan', name: 'ËèØÂçóÈäÄË°å *28298', type: 'personal' },
            { id: 'my_cathay', name: 'ÂúãÊ≥∞‰∏ñËèØ *34757', type: 'personal' },
            { id: 'my_fubon', name: 'Âè∞ÂåóÂØåÈÇ¶ *63204', type: 'personal' },
            { id: 'my_sinopac', name: 'Ê∞∏Ë±êÈäÄË°å *83224', type: 'personal' },
            { id: 'my_chb', name: 'ÂΩ∞ÂåñÈäÄË°å *85700', type: 'personal' },
            { id: 'my_tcbb', name: 'Âè∞‰∏≠ÈäÄË°å *68887', type: 'personal' },
            { id: 'my_post', name: '‰∏≠ËèØÈÉµÊîø *30626', type: 'personal' },
            { id: 'my_taishin', name: 'Âè∞Êñ∞ÈäÄË°å', type: 'personal' },
            { id: 'my_obank', name: 'ÁéãÈÅìÈäÄË°å', type: 'personal' },
            { id: 'my_card', name: '‰ø°Áî®Âç°', type: 'personal' },
            
            // --- ÂÖ¨Âè∏Â∏≥Êà∂Áæ§ ---
            { id: 'dalin_obank', name: 'Â§ßÊûó-ÁéãÈÅìÈäÄË°å', type: 'company' },
            { id: 'bade_obank', name: 'ÂÖ´Âæ∑-ÁéãÈÅìÈäÄË°å', type: 'company' },
            { id: 'guanyin_obank', name: 'ËßÄÈü≥-ÁéãÈÅìÈäÄË°å', type: 'company' },
            { id: 'nankan_obank', name: 'ÂçóÂ¥Å-ÁéãÈÅìÈäÄË°å', type: 'company' },
            { id: 'yemo_huanan', name: 'ÈáéÈôå-ËèØÂçóÈäÄË°å (ÂÖ¨)', type: 'company' }, 
            { id: 'company_general', name: 'ÂÖ∂‰ªñÂÖ¨Âè∏Êà∂/Â∫óÂÖßÈáë', type: 'company' }, 
        ];

        // --- 3. ËºîÂä©ÂáΩÂºè ---
        const isPersonalAccount = (id) => ACCOUNTS.find(a => a.id === id)?.type === 'personal';
        const getAccountName = (id) => ACCOUNTS.find(a => a.id === id)?.name || id;
        const getShopName = (id) => SHOPS.find(s => s.id === id)?.name || id;

        // --- 4. Áç®Á´ãË¶ñÂúñÁµÑ‰ª∂ ---

        const ShopSelector = ({ selectedShop, setSelectedShop }) => {
            // ÂÆöÁæ©ÂàÜÁµÑÊ®ôÁ±§
            const tabs = [
                { key: 'mahjong', label: 'üÄÑ È∫ªÂ∞áÈ§®', color: 'text-blue-600' },
                { key: 'yemo', label: 'üçΩÔ∏è ÈáéÈôå', color: 'text-emerald-600' },
                { key: 'general', label: '‚öôÔ∏è Á∏ΩÁÆ°/ÂÄã‰∫∫', color: 'text-gray-600' },
            ];

            const [activeTab, setActiveTab] = useState('mahjong');

            // Á¢∫‰øùÂàáÊèõ selectedShop ÊôÇÔºåTab ‰πüÊúÉË∑üËëóËÆä (ÂàùÂßãÂåñ)
            useEffect(() => {
                const shop = SHOPS.find(s => s.id === selectedShop);
                if (shop) setActiveTab(shop.group);
            }, [selectedShop]);

            return (
                <div className="mb-4">
                    {/* ÂàÜÁµÑ Tabs */}
                    <div className="flex border-b border-gray-200 mb-3">
                        {tabs.map(tab => (
                            <button
                                key={tab.key}
                                onClick={() => setActiveTab(tab.key)}
                                className={`flex-1 py-2 text-sm font-bold border-b-2 transition-colors ${
                                    activeTab === tab.key 
                                        ? `border-blue-500 text-gray-900` 
                                        : 'border-transparent text-gray-400 hover:text-gray-600'
                                }`}
                            >
                                {tab.label}
                            </button>
                        ))}
                    </div>

                    {/* Ë©≤ÁµÑÂà•‰∏ãÁöÑÂ∫óÈã™ÂàóË°® */}
                    <div className="grid grid-cols-3 gap-2 animate-fade-in">
                        {SHOPS.filter(s => s.group === activeTab).map(shop => (
                            <button
                                key={shop.id}
                                onClick={() => setSelectedShop(shop.id)}
                                className={`p-1 rounded-lg text-xs font-bold text-center transition-all flex flex-col items-center justify-center h-16 ${
                                    selectedShop === shop.id 
                                        ? 'ring-2 ring-offset-1 ring-blue-500 shadow-md transform scale-105 ' + shop.color
                                        : 'bg-white border border-gray-100 text-gray-500 hover:bg-gray-50'
                                }`}
                            >
                                {shop.id === 'company_pool' ? <Briefcase size={20} className="mb-1"/> : null}
                                {shop.id === 'family' ? <Home size={20} className="mb-1"/> : null}
                                <span className="scale-90">{shop.name.replace('È∫ªÂ∞á', '').replace('È§êÂª≥', '')}</span>
                            </button>
                        ))}
                    </div>
                    {/* ÊèêÁ§∫Ë™û */}
                    {activeTab === 'general' && selectedShop === 'company_pool' && (
                         <p className="text-[10px] text-gray-500 mt-2 bg-gray-100 p-2 rounded text-center">
                            üí° ÊèêÁ§∫ÔºöÁï∂Âæû„ÄåÊ∑∑Áî®Â∏≥Êà∂„ÄçËΩâÂ∏≥‰∏ÄÂ§ßÁ≠ÜÈå¢Âá∫‰æÜÊôÇÔºåË´ãÈÅ∏Ê≠§È†Ö„ÄÇ
                        </p>
                    )}
                </div>
            );
        };

        const AddView = ({ 
            date, setDate, selectedShop, setSelectedShop, type, setType, 
            amount, setAmount, category, setCategory, accountId, setAccountId, 
            toAccountId, setToAccountId,
            note, setNote, handleSave, availableCategories 
        }) => {
            return (
                <div className="p-4 pb-24 max-w-md mx-auto">
                    <h2 className="text-xl font-bold text-gray-800 mb-3 flex items-center">
                        <Plus className="w-6 h-6 mr-2 text-blue-600" />
                        Ë®ò‰∏ÄÁ≠Ü
                    </h2>
                    
                    <label className="text-sm font-medium text-gray-500 mb-1 block">1. Ê≠∏Â±¨Â∞çË±°</label>
                    <ShopSelector selectedShop={selectedShop} setSelectedShop={setSelectedShop} />

                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-4 mt-2">
                        <div className="flex bg-gray-100 p-1 rounded-lg mb-4">
                            <button 
                                onClick={() => setType('expense')}
                                className={`flex-1 py-2 rounded-md text-sm font-bold flex items-center justify-center ${type === 'expense' ? 'bg-red-500 text-white shadow-sm' : 'text-gray-500'}`}
                            >
                                <TrendingDown className="w-4 h-4 mr-1" /> ÊîØÂá∫
                            </button>
                            <button 
                                onClick={() => setType('income')}
                                className={`flex-1 py-2 rounded-md text-sm font-bold flex items-center justify-center ${type === 'income' ? 'bg-green-500 text-white shadow-sm' : 'text-gray-500'}`}
                            >
                                <TrendingUp className="w-4 h-4 mr-1" /> Êî∂ÂÖ•
                            </button>
                            <button 
                                onClick={() => setType('transfer')}
                                className={`flex-1 py-2 rounded-md text-sm font-bold flex items-center justify-center ${type === 'transfer' ? 'bg-blue-500 text-white shadow-sm' : 'text-gray-500'}`}
                            >
                                <ArrowRightLeft className="w-4 h-4 mr-1" /> ËΩâÂ∏≥
                            </button>
                        </div>

                        <div className="flex gap-3 mb-4">
                            <div className="flex-1">
                                <label className="text-xs text-gray-500 mb-1 block">ÈáëÈ°ç</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-3 text-gray-400">$</span>
                                    <input 
                                        type="number" 
                                        inputMode="decimal"
                                        value={amount} 
                                        onChange={e => setAmount(e.target.value)}
                                        placeholder="0"
                                        className="w-full p-3 pl-8 text-2xl font-bold bg-gray-50 rounded-lg border-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                            </div>
                            <div className="w-1/3">
                                 <label className="text-xs text-gray-500 mb-1 block">Êó•Êúü</label>
                                 <input 
                                    type="date" 
                                    value={date} 
                                    onChange={e => setDate(e.target.value)}
                                    className="w-full p-3 h-[56px] bg-gray-50 rounded-lg border-none focus:ring-2 focus:ring-blue-500 text-sm"
                                />
                            </div>
                        </div>

                        {type === 'transfer' ? (
                            <div className="bg-blue-50 p-3 rounded-lg mb-4 border border-blue-100">
                                <div className="mb-3">
                                    <label className="text-xs text-gray-500 mb-1 block flex items-center">
                                        <span className="w-2 h-2 rounded-full bg-red-400 mr-1"></span>
                                        ËΩâÂá∫Â∏≥Êà∂ (Èå¢ËÆäÂ∞ë)
                                    </label>
                                    <select 
                                        value={accountId} 
                                        onChange={e => setAccountId(e.target.value)}
                                        className="w-full p-2 bg-white rounded border border-gray-200 text-sm"
                                    >
                                        <optgroup label="ÊàëÁöÑÂÄã‰∫∫Ë≥áÁî¢">
                                            {ACCOUNTS.filter(a => a.type === 'personal').map(acc => (
                                                <option key={acc.id} value={acc.id}>{acc.name}</option>
                                            ))}
                                        </optgroup>
                                        <optgroup label="ÂÖ¨Âè∏Êà∂È†≠">
                                            {ACCOUNTS.filter(a => a.type === 'company').map(acc => (
                                                <option key={acc.id} value={acc.id}>{acc.name}</option>
                                            ))}
                                        </optgroup>
                                    </select>
                                </div>
                                <div className="flex justify-center -my-2 relative z-10">
                                    <div className="bg-white rounded-full p-1 border border-gray-200">
                                        <ArrowRightLeft className="w-4 h-4 text-gray-400" />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs text-gray-500 mb-1 block flex items-center">
                                        <span className="w-2 h-2 rounded-full bg-green-400 mr-1"></span>
                                        ËΩâÂÖ•Â∏≥Êà∂ (Èå¢ËÆäÂ§ö)
                                    </label>
                                    <select 
                                        value={toAccountId} 
                                        onChange={e => setToAccountId(e.target.value)}
                                        className="w-full p-2 bg-white rounded border border-gray-200 text-sm"
                                    >
                                        <optgroup label="ÊàëÁöÑÂÄã‰∫∫Ë≥áÁî¢">
                                            {ACCOUNTS.filter(a => a.type === 'personal').map(acc => (
                                                <option key={acc.id} value={acc.id}>{acc.name}</option>
                                            ))}
                                        </optgroup>
                                        <optgroup label="ÂÖ¨Âè∏Êà∂È†≠">
                                            {ACCOUNTS.filter(a => a.type === 'company').map(acc => (
                                                <option key={acc.id} value={acc.id}>{acc.name}</option>
                                            ))}
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                        ) : (
                            <div className="mb-4">
                                <label className="text-xs text-gray-500 mb-1 block">ÊîØ‰ªòÊñπÂºè / ÂÖ•Â∏≥Â∏≥Êà∂</label>
                                <div className="relative">
                                    <Landmark className="absolute left-3 top-3.5 text-gray-400 w-5 h-5" />
                                    <select 
                                        value={accountId} 
                                        onChange={e => setAccountId(e.target.value)}
                                        className="w-full p-3 pl-10 bg-amber-50 text-gray-800 font-medium rounded-lg border border-amber-200 focus:ring-2 focus:ring-amber-500 appearance-none"
                                    >
                                    <optgroup label="ÊàëÁöÑÂÄã‰∫∫Ë≥áÁî¢ (‰ª£Â¢ä/Ëá™Áî®)">
                                        {ACCOUNTS.filter(a => a.type === 'personal').map(acc => (
                                        <option key={acc.id} value={acc.id}>{acc.name}</option>
                                        ))}
                                    </optgroup>
                                    <optgroup label="ÂÖ¨Âè∏Êà∂È†≠ (Ëá™ÂãïÊâ£Ê¨æ/ÂÖ¨Âè∏‰ªò)">
                                        {ACCOUNTS.filter(a => a.type === 'company').map(acc => (
                                        <option key={acc.id} value={acc.id}>{acc.name}</option>
                                        ))}
                                    </optgroup>
                                    </select>
                                </div>
                                {type === 'expense' && selectedShop !== 'family' && selectedShop !== 'company_pool' && (
                                    <p className="text-xs mt-1 ml-1">
                                    {isPersonalAccount(accountId) 
                                        ? <span className="text-red-500 font-bold">‚ö†Ô∏è Â∞áË®àÂÖ•‰ª£Â¢äÊ¨æ (ÂÖ¨Âè∏Ê¨†Â¶≥)</span>
                                        : <span className="text-green-600">‚úÖ ÂÖ¨Âè∏Ëá™Ë°åÊîØ‰ªò (‰∏çË®à‰ª£Â¢ä)</span>
                                    }
                                    </p>
                                )}
                            </div>
                        )}

                        {type !== 'transfer' && (
                            <div className="mb-4">
                                <label className="text-xs text-gray-500 mb-1 block">ÂàÜÈ°û</label>
                                <div className="grid grid-cols-3 gap-2">
                                    {availableCategories.map(cat => (
                                        <button
                                            key={cat}
                                            onClick={() => setCategory(cat)}
                                            className={`p-2 rounded-lg text-xs ${category === cat ? 'bg-blue-100 text-blue-700 border border-blue-200 font-bold' : 'bg-gray-50 text-gray-600 border border-transparent'}`}
                                        >
                                            {cat}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div>
                            <label className="text-xs text-gray-500 mb-1 block">ÂÇôË®ª</label>
                            <input 
                                type="text" 
                                value={note} 
                                onChange={e => setNote(e.target.value)}
                                placeholder={type === 'transfer' ? "‰æãÂ¶ÇÔºöÂ≠òÁáüÊ•≠È°ç„ÄÅË™øÂ∫¶Ë≥áÈáë..." : "ÂÇôË®ªË™™Êòé..."}
                                className="w-full p-3 bg-gray-50 rounded-lg border-none"
                            />
                        </div>
                    </div>

                    <button 
                        onClick={handleSave}
                        className={`w-full py-4 text-white rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform ${type === 'transfer' ? 'bg-blue-600' : 'bg-gray-900'}`}
                    >
                        {type === 'transfer' ? 'Á¢∫Ë™çËΩâÂ∏≥' : 'Á¢∫Ë™çÂÑ≤Â≠ò'}
                    </button>
                </div>
            );
        };

        const ReportView = ({ transactions }) => {
            const currentMonth = new Date().toISOString().slice(0, 7);
            const [monthFilter, setMonthFilter] = useState(currentMonth);

            const filteredTx = useMemo(() => {
                return transactions.filter(t => t.date.startsWith(monthFilter));
            }, [transactions, monthFilter]);

            const handleExportCSV = () => {
                const headers = ['Êó•Êúü', 'Ê≠∏Â±¨Â∞çË±°(Â∫óÈã™)', 'È°ûÂûã', 'ÈáëÈ°ç', 'ÂàÜÈ°û', 'ËΩâÂá∫/ÊîØ‰ªòÂ∏≥Êà∂', 'ËΩâÂÖ•Â∏≥Êà∂', 'ÂÇôË®ª'];
                const rows = filteredTx.map(t => {
                    let typeName = 'ÊîØÂá∫';
                    if (t.type === 'income') typeName = 'Êî∂ÂÖ•';
                    if (t.type === 'transfer') typeName = 'ÂÖßÈÉ®ËΩâÂ∏≥';
                    
                    return [
                        t.date,
                        getShopName(t.shopId),
                        typeName,
                        t.amount,
                        t.category || '-',
                        getAccountName(t.accountId),
                        t.toAccountId ? getAccountName(t.toAccountId) : '-',
                        t.note || ''
                    ];
                });

                const csvContent = [
                    '\uFEFF' + headers.join(','),
                    ...rows.map(row => row.map(item => `"${item}"`).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `Ë≤°ÂãôÂ†±Ë°®_${monthFilter}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const reportData = SHOPS.filter(s => s.type === 'business' && s.id !== 'company_pool').map(shop => {
                const shopTx = filteredTx.filter(t => t.shopId === shop.id);
                const income = shopTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expense = shopTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                return { ...shop, income, expense, profit: income - expense };
            });

            const totalAdvanced = filteredTx
                .filter(t => t.type === 'expense' && t.shopId !== 'family' && t.shopId !== 'company_pool' && isPersonalAccount(t.accountId))
                .reduce((sum, t) => sum + t.amount, 0);

            const totalPersonalExpense = filteredTx
                .filter(t => t.type === 'expense' && t.shopId === 'family')
                .reduce((sum, t) => sum + t.amount, 0);

            return (
                <div className="p-4 pb-24 max-w-md mx-auto bg-gray-50 min-h-screen">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-bold text-gray-800 flex items-center">
                            <PieChart className="w-6 h-6 mr-2 text-purple-600" /> ÊêçÁõäÂ†±Ë°®
                        </h2>
                        <div className="flex gap-2">
                            <input 
                                type="month" 
                                value={monthFilter}
                                onChange={e => setMonthFilter(e.target.value)}
                                className="text-sm bg-white border border-gray-300 rounded px-2 py-1 w-32"
                            />
                            <button 
                                onClick={handleExportCSV}
                                className="bg-blue-600 text-white p-1.5 rounded shadow-sm hover:bg-blue-700 active:scale-95"
                                title="‰∏ãËºâÊú¨ÊúàÂ†±Ë°®"
                            >
                                <Download size={20} />
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-3 mb-6">
                        <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500 relative overflow-hidden">
                            <div className="absolute right-0 top-0 p-1 opacity-10"><Wallet size={40}/></div>
                            <div className="text-gray-500 text-xs font-bold mb-1">Êú¨ÊúàÂ¶≥ÂÖàÂ¢äÁöÑÈå¢</div>
                            <div className="text-xl font-bold text-red-600">${totalAdvanced.toLocaleString()}</div>
                            <div className="text-[10px] text-gray-400 mt-1">Âè™Ë®àÁÆóÂàÜÂ∫óÊîØÂá∫</div>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-400">
                            <div className="text-gray-500 text-xs font-bold mb-1">Êú¨ÊúàÂÆ∂Áî®/ÂÄã‰∫∫Ëä±Ë≤ª</div>
                            <div className="text-xl font-bold text-gray-900">${totalPersonalExpense.toLocaleString()}</div>
                        </div>
                    </div>

                    <h3 className="text-sm font-bold text-gray-600 mb-3 px-1">ÂêÑÂ∫óÊú¨ÊúàÊêçÁõä (Ë≥∫ - Ë≥†)</h3>
                    <div className="space-y-3">
                        {reportData.map(shop => (
                            <div key={shop.id} className="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center">
                                <div className="flex items-center">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center mr-3 ${shop.color}`}>
                                        <span className="text-lg font-bold">{shop.name.charAt(0)}</span>
                                    </div>
                                    <div>
                                        <div className="font-bold text-gray-800">{shop.name}</div>
                                        <div className="text-[10px] text-gray-400">
                                            Êî∂ ${shop.income.toLocaleString()} / ÊîØ ${shop.expense.toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                                <div className={`text-right font-bold ${shop.profit >= 0 ? 'text-green-600' : 'text-red-500'}`}>
                                    {shop.profit >= 0 ? '+' : ''}{shop.profit.toLocaleString()}
                                    <div className="text-[10px] font-normal text-gray-400">Ê∑®Âà©</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ListView = ({ transactions, handleDelete }) => {
            const [filterShop, setFilterShop] = useState('all');

            const displayTx = transactions
                .filter(t => filterShop === 'all' || t.shopId === filterShop)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            return (
                <div className="p-4 pb-24 max-w-md mx-auto">
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center justify-between">
                        <span className="flex items-center"><ListIcon className="w-6 h-6 mr-2 text-green-600" /> Â∏≥ÂãôÊòéÁ¥∞</span>
                        <select 
                            className="text-sm border rounded p-1"
                            value={filterShop}
                            onChange={e => setFilterShop(e.target.value)}
                        >
                            <option value="all">ÂÖ®ÈÉ®Á¥ÄÈåÑ</option>
                            {SHOPS.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                        </select>
                    </h2>

                    <div className="space-y-2">
                        {displayTx.length === 0 && <div className="text-center text-gray-400 py-10">Â∞öÁÑ°Ë≥áÊñô</div>}
                        {displayTx.map(tx => {
                            const shop = SHOPS.find(s => s.id === tx.shopId);
                            const isPersonal = isPersonalAccount(tx.accountId);
                            const isTransfer = tx.type === 'transfer';
                            
                            return (
                                <div key={tx.id} className="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <div className={`text-xs font-bold px-2 py-1 rounded ${shop?.color}`}>
                                            {shop?.name.slice(0, 2)}
                                        </div>
                                        <div>
                                            <div className="font-bold text-gray-800 text-sm flex items-center gap-2">
                                                {isTransfer ? (
                                                    <span className="text-blue-600 flex items-center">
                                                        ËΩâÂ∏≥ <ArrowRightLeft className="w-3 h-3 ml-1" />
                                                    </span>
                                                ) : tx.category}
                                            </div>
                                            <div className="text-xs text-gray-500 mt-1">
                                                {isTransfer ? (
                                                    <span className="flex items-center gap-1 bg-gray-100 px-1 rounded">
                                                        {getAccountName(tx.accountId)} 
                                                        <span className="text-gray-400">‚ûî</span>
                                                        {getAccountName(tx.toAccountId)}
                                                    </span>
                                                ) : (
                                                     <span className={`px-1 rounded border ${isPersonal ? 'bg-amber-50 text-amber-700 border-amber-200' : 'bg-gray-50 text-gray-500 border-gray-200'}`}>
                                                        {getAccountName(tx.accountId)}
                                                     </span>
                                                )}
                                            </div>
                                            <div className="text-[10px] text-gray-400 mt-0.5">{tx.date} {tx.note && `‚Ä¢ ${tx.note}`}</div>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <span className={`font-bold ${
                                            tx.type === 'income' ? 'text-green-600' : 
                                            tx.type === 'expense' ? 'text-red-500' : 'text-blue-500'
                                        }`}>
                                            {tx.type === 'income' ? '+' : tx.type === 'expense' ? '-' : ''}${tx.amount.toLocaleString()}
                                        </span>
                                        <button onClick={() => handleDelete(tx.id)} className="text-gray-300 hover:text-red-500">
                                            <Trash2 size={16} />
                                        </button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('add');
            const [transactions, setTransactions] = useState(() => {
                const saved = localStorage.getItem('boss_finance_data_v3'); 
                return saved ? JSON.parse(saved) : [];
            });

            // Form State
            const [date, setDate] = useState(new Date().toISOString().slice(0, 10));
            const [selectedShop, setSelectedShop] = useState(SHOPS[0].id);
            const [type, setType] = useState('expense');
            const [amount, setAmount] = useState('');
            const [category, setCategory] = useState('');
            const [accountId, setAccountId] = useState('my_cash'); 
            const [toAccountId, setToAccountId] = useState('my_ctbc'); 
            const [note, setNote] = useState('');

            useEffect(() => {
                localStorage.setItem('boss_finance_data_v3', JSON.stringify(transactions));
            }, [transactions]);

            const currentShopType = SHOPS.find(s => s.id === selectedShop)?.type || 'business';
            const availableCategories = useMemo(() => currentShopType === 'business' 
                ? (type === 'expense' ? CATEGORIES.business_expense : CATEGORIES.business_income)
                : (type === 'expense' ? CATEGORIES.personal_expense : CATEGORIES.personal_income), [currentShopType, type]);

            useEffect(() => {
                if (type !== 'transfer') {
                    setCategory(availableCategories[0]);
                }
            }, [type, selectedShop, currentShopType]); 

            const handleSave = () => {
                if (!amount) return alert('Ë´ãËº∏ÂÖ•ÈáëÈ°ç');
                if (type === 'transfer' && accountId === toAccountId) return alert('ËΩâÂá∫ËàáËΩâÂÖ•Â∏≥Êà∂‰∏çËÉΩÁõ∏Âêå');
                
                const newTx = {
                    id: Date.now(),
                    date,
                    shopId: selectedShop,
                    type,
                    amount: parseFloat(amount),
                    category: type === 'transfer' ? 'ÂÖßÈÉ®ËΩâÂ∏≥' : category,
                    accountId,
                    toAccountId: type === 'transfer' ? toAccountId : null,
                    note,
                };

                setTransactions([newTx, ...transactions]);
                setAmount('');
                setNote('');
                alert(type === 'transfer' ? 'ËΩâÂ∏≥Á¥ÄÈåÑÂ∑≤‰øùÂ≠ò' : 'Â∑≤Ë®òÈåÑÔºÅ');
            };

            const handleDelete = (id) => {
                if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÁ¥ÄÈåÑÂóéÔºü')) {
                    setTransactions(transactions.filter(t => t.id !== id));
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-900">
                    {view === 'add' && <AddView 
                        date={date} setDate={setDate}
                        selectedShop={selectedShop} setSelectedShop={setSelectedShop}
                        type={type} setType={setType}
                        amount={amount} setAmount={setAmount}
                        category={category} setCategory={setCategory}
                        accountId={accountId} setAccountId={setAccountId}
                        toAccountId={toAccountId} setToAccountId={setToAccountId}
                        note={note} setNote={setNote}
                        handleSave={handleSave}
                        availableCategories={availableCategories}
                    />}
                    
                    {view === 'list' && <ListView transactions={transactions} handleDelete={handleDelete} />}
                    
                    {view === 'report' && <ReportView transactions={transactions} />}

                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3 flex justify-between items-center pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-50">
                        <button onClick={() => setView('add')} className={`flex flex-col items-center space-y-1 ${view === 'add' ? 'text-blue-600' : 'text-gray-400'}`}>
                            <div className={`p-1 rounded-full ${view === 'add' ? 'bg-blue-50' : ''}`}><Plus size={24} strokeWidth={2.5} /></div>
                            <span className="text-[10px] font-bold">Ë®òÂ∏≥</span>
                        </button>
                        <button onClick={() => setView('list')} className={`flex flex-col items-center space-y-1 ${view === 'list' ? 'text-blue-600' : 'text-gray-400'}`}>
                            <ListIcon size={24} strokeWidth={2.5} />
                            <span className="text-[10px] font-bold">ÊòéÁ¥∞</span>
                        </button>
                        <button onClick={() => setView('report')} className={`flex flex-col items-center space-y-1 ${view === 'report' ? 'text-blue-600' : 'text-gray-400'}`}>
                            <PieChart size={24} strokeWidth={2.5} />
                            <span className="text-[10px] font-bold">Â†±Ë°®</span>
                        </button>
                    </div>
                    <div className="h-20"></div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

