<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â§öÂ∫óË≤°ÂãôÁ∏ΩÁÆ°</title>
    
    <!-- ÂºïÂÖ• React Âíå Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .no-select { user-select: none; -webkit-user-select: none; }
        /* Èò≤Ê≠¢ iOS ÈªûÊìäËº∏ÂÖ•Ê°ÜÊîæÂ§ß */
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 no-select">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 1. ÂúñÁ§∫ÁµÑ‰ª∂ ---
        const IconWrapper = ({ children, className, onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>{children}</svg>
        );
        const Plus = (p) => <IconWrapper {...p}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconWrapper>;
        const ListIcon = (p) => <IconWrapper {...p}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></IconWrapper>;
        const PieChart = (p) => <IconWrapper {...p}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></IconWrapper>;
        const Trash2 = (p) => <IconWrapper {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconWrapper>;
        const TrendingUp = (p) => <IconWrapper {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></IconWrapper>;
        const TrendingDown = (p) => <IconWrapper {...p}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></IconWrapper>;
        const Home = (p) => <IconWrapper {...p}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></IconWrapper>;
        const Wallet = (p) => <IconWrapper {...p}><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"></path><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"></path></IconWrapper>;
        const Building2 = (p) => <IconWrapper {...p}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"></path><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"></path><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"></path><path d="M10 6h4"></path><path d="M10 10h4"></path><path d="M10 14h4"></path><path d="M10 18h4"></path></IconWrapper>;
        const Landmark = (p) => <IconWrapper {...p}><line x1="3" y1="22" x2="21" y2="22"></line><line x1="6" y1="18" x2="6" y2="11"></line><line x1="10" y1="18" x2="10" y2="11"></line><line x1="14" y1="18" x2="14" y2="11"></line><line x1="18" y1="18" x2="18" y2="11"></line><polygon points="12 2 20 7 4 7"></polygon></IconWrapper>;
        const Download = (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></IconWrapper>;

        // --- 2. Ë®≠ÂÆöÊ™î (Ë≥áÊñô) ---
        const SHOPS = [
            { id: 'dalin', name: 'Â§ßÊûóÈ∫ªÂ∞á', type: 'business', color: 'bg-blue-100 text-blue-800' },
            { id: 'bade', name: 'ÂÖ´Âæ∑È∫ªÂ∞á', type: 'business', color: 'bg-indigo-100 text-indigo-800' },
            { id: 'guanyin', name: 'ËßÄÈü≥È∫ªÂ∞á', type: 'business', color: 'bg-purple-100 text-purple-800' },
            { id: 'nankan', name: 'ÂçóÂ¥ÅÈ∫ªÂ∞á', type: 'business', color: 'bg-pink-100 text-pink-800' },
            { id: 'yangmei', name: 'Ê•äÊ¢ÖÈ∫ªÂ∞á', type: 'business', color: 'bg-rose-100 text-rose-800' },
            { id: 'zhonghe', name: '‰∏≠ÂíåÈ∫ªÂ∞á', type: 'business', color: 'bg-orange-100 text-orange-800' },
            { id: 'yemo', name: 'ÈáéÈôåÈ§êÂª≥', type: 'business', color: 'bg-emerald-100 text-emerald-800' },
            { id: 'family', name: 'ÂÆ∂Â∫≠/ÂÄã‰∫∫', type: 'personal', color: 'bg-slate-200 text-slate-800' },
        ];

        const CATEGORIES = {
            business_expense: ['ÁßüÈáë', 'Á®ÖÈáë', 'ÈÄ≤Ë≤®/È£üÊùê', 'Ê∞¥ÈõªÁì¶ÊñØ', 'Âª£ÂëäË≤ª', '‰∫∫‰∫ãËñ™Ë≥á', 'Á∂≠‰øÆÈõúÊîØ', 'Ë®≠ÂÇô', 'ÂÖ∂‰ªñ'],
            business_income: ['ÁáüÊ•≠Êî∂ÂÖ•', 'ÂÑ≤ÂÄºÂÖ•Â∏≥', 'ÂÖ∂‰ªñÊî∂ÂÖ•'],
            personal_expense: ['Â≠∏Ë≤ª', 'ÁîüÊ¥ªË≤ª', '‰øùÈö™Ë≤ª', '‰ø°Áî®Âç°Ë≤ª', 'Ë≥ºÁâ©', 'È§êË≤ª', '‰∫§ÈÄö', 'ÂÖ∂‰ªñ'],
            personal_income: ['Ëñ™Ë≥á', 'ÊäïË≥áÊî∂Áõä', 'Â∫óÈã™ÁõàÈ§òÊèêÈ†ò', 'ÂÖ∂‰ªñ'],
        };

        const ACCOUNTS = [
            { id: 'my_cash', name: 'ÊàëÁöÑÁèæÈáë', type: 'personal' },
            { id: 'my_card', name: 'ÊàëÁöÑ‰ø°Áî®Âç°', type: 'personal' },
            { id: 'my_bank', name: 'ÊàëÁöÑÈäÄË°åÂ∏≥Êà∂', type: 'personal' },
            { id: 'dalin_obank', name: 'Â§ßÊûó-ÁéãÈÅìÈäÄË°å', type: 'company' },
            { id: 'bade_obank', name: 'ÂÖ´Âæ∑-ÁéãÈÅìÈäÄË°å', type: 'company' },
            { id: 'guanyin_obank', name: 'ËßÄÈü≥-ÁéãÈÅìÈäÄË°å', type: 'company' },
            { id: 'nankan_obank', name: 'ÂçóÂ¥Å-ÁéãÈÅìÈäÄË°å', type: 'company' },
            { id: 'yemo_huanan', name: 'ÈáéÈôå-ËèØÂçóÈäÄË°å', type: 'company' },
            { id: 'company_general', name: 'ÂÖ∂‰ªñÂÖ¨Âè∏Êà∂/Â∫óÂÖßÈáë', type: 'company' }, 
        ];

        // --- 3. ËºîÂä©ÂáΩÂºè ---
        const isPersonalAccount = (id) => ACCOUNTS.find(a => a.id === id)?.type === 'personal';
        const getAccountName = (id) => ACCOUNTS.find(a => a.id === id)?.name || id;
        const getShopName = (id) => SHOPS.find(s => s.id === id)?.name || id;

        // --- 4. Áç®Á´ãË¶ñÂúñÁµÑ‰ª∂ (‰øÆÊ≠£ÈçµÁõ§ÂïèÈ°åÁöÑÈóúÈçµÔºöÁßªÂà∞ App Â§ñÈù¢) ---

        // 4.1 Êñ∞Â¢ûÈ†ÅÈù¢
        const AddView = ({ 
            date, setDate, selectedShop, setSelectedShop, type, setType, 
            amount, setAmount, category, setCategory, accountId, setAccountId, 
            note, setNote, handleSave, availableCategories 
        }) => {
            return (
                <div className="p-4 pb-24 max-w-md mx-auto">
                    <h2 className="text-xl font-bold text-gray-800 mb-3 flex items-center">
                        <Plus className="w-6 h-6 mr-2 text-blue-600" />
                        Ë®ò‰∏ÄÁ≠Ü
                    </h2>
                    
                    <label className="text-sm font-medium text-gray-500 mb-1 block">1. Ê≠∏Â±¨Â∞çË±°</label>
                    <div className="grid grid-cols-4 gap-2 mb-4">
                        {SHOPS.map(shop => (
                            <button
                                key={shop.id}
                                onClick={() => setSelectedShop(shop.id)}
                                className={`p-1 rounded-lg text-xs font-bold text-center transition-all flex flex-col items-center justify-center h-20 ${
                                    selectedShop === shop.id 
                                        ? 'ring-2 ring-offset-1 ring-blue-500 shadow-md transform scale-105 ' + shop.color
                                        : 'bg-gray-50 text-gray-500 opacity-80'
                                }`}
                            >
                                {shop.id === 'yemo' ? 'üçΩÔ∏è' : shop.id === 'family' ? 'üè†' : 'üÄÑ'}
                                <span className="mt-1 scale-90">{shop.name.replace('È∫ªÂ∞á', '').replace('È§êÂª≥', '')}</span>
                            </button>
                        ))}
                    </div>

                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-4">
                        <div className="flex bg-gray-100 p-1 rounded-lg mb-4">
                            <button 
                                onClick={() => setType('expense')}
                                className={`flex-1 py-2 rounded-md text-sm font-bold flex items-center justify-center ${type === 'expense' ? 'bg-red-500 text-white shadow-sm' : 'text-gray-500'}`}
                            >
                                <TrendingDown className="w-4 h-4 mr-1" /> ÊîØÂá∫
                            </button>
                            <button 
                                onClick={() => setType('income')}
                                className={`flex-1 py-2 rounded-md text-sm font-bold flex items-center justify-center ${type === 'income' ? 'bg-green-500 text-white shadow-sm' : 'text-gray-500'}`}
                            >
                                <TrendingUp className="w-4 h-4 mr-1" /> Êî∂ÂÖ•
                            </button>
                        </div>

                        <div className="flex gap-3 mb-4">
                            <div className="flex-1">
                                <label className="text-xs text-gray-500 mb-1 block">ÈáëÈ°ç</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-3 text-gray-400">$</span>
                                    <input 
                                        type="number" 
                                        inputMode="decimal"
                                        value={amount} 
                                        onChange={e => setAmount(e.target.value)}
                                        placeholder="0"
                                        className="w-full p-3 pl-8 text-2xl font-bold bg-gray-50 rounded-lg border-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                            </div>
                            <div className="w-1/3">
                                 <label className="text-xs text-gray-500 mb-1 block">Êó•Êúü</label>
                                 <input 
                                    type="date" 
                                    value={date} 
                                    onChange={e => setDate(e.target.value)}
                                    className="w-full p-3 h-[56px] bg-gray-50 rounded-lg border-none focus:ring-2 focus:ring-blue-500 text-sm"
                                />
                            </div>
                        </div>

                        <div className="mb-4">
                           <label className="text-xs text-gray-500 mb-1 block">ÊîØ‰ªòÊñπÂºè / ÂÖ•Â∏≥Â∏≥Êà∂</label>
                           <div className="relative">
                             <Landmark className="absolute left-3 top-3.5 text-gray-400 w-5 h-5" />
                             <select 
                                value={accountId} 
                                onChange={e => setAccountId(e.target.value)}
                                className="w-full p-3 pl-10 bg-amber-50 text-gray-800 font-medium rounded-lg border border-amber-200 focus:ring-2 focus:ring-amber-500 appearance-none"
                             >
                               <optgroup label="ÊàëÁöÑÂÄã‰∫∫Ë≥áÁî¢ (‰ª£Â¢ä/Ëá™Áî®)">
                                 {ACCOUNTS.filter(a => a.type === 'personal').map(acc => (
                                   <option key={acc.id} value={acc.id}>{acc.name}</option>
                                 ))}
                               </optgroup>
                               <optgroup label="ÂÖ¨Âè∏Êà∂È†≠ (Ëá™ÂãïÊâ£Ê¨æ/ÂÖ¨Âè∏‰ªò)">
                                 {ACCOUNTS.filter(a => a.type === 'company').map(acc => (
                                   <option key={acc.id} value={acc.id}>{acc.name}</option>
                                 ))}
                               </optgroup>
                             </select>
                           </div>
                           {type === 'expense' && selectedShop !== 'family' && (
                             <p className="text-xs mt-1 ml-1">
                               {isPersonalAccount(accountId) 
                                 ? <span className="text-red-500 font-bold">‚ö†Ô∏è Â∞áË®àÂÖ•‰ª£Â¢äÊ¨æ (ÂÖ¨Âè∏Ê¨†Â¶≥)</span>
                                 : <span className="text-green-600">‚úÖ ÂÖ¨Âè∏Ëá™Ë°åÊîØ‰ªò (‰∏çË®à‰ª£Â¢ä)</span>
                               }
                             </p>
                           )}
                        </div>

                        <div className="mb-4">
                            <label className="text-xs text-gray-500 mb-1 block">ÂàÜÈ°û</label>
                            <div className="grid grid-cols-3 gap-2">
                                {availableCategories.map(cat => (
                                    <button
                                        key={cat}
                                        onClick={() => setCategory(cat)}
                                        className={`p-2 rounded-lg text-xs ${category === cat ? 'bg-blue-100 text-blue-700 border border-blue-200 font-bold' : 'bg-gray-50 text-gray-600 border border-transparent'}`}
                                    >
                                        {cat}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <label className="text-xs text-gray-500 mb-1 block">ÂÇôË®ª</label>
                            <input 
                                type="text" 
                                value={note} 
                                onChange={e => setNote(e.target.value)}
                                placeholder="ÂÇôË®ªË™™Êòé..."
                                className="w-full p-3 bg-gray-50 rounded-lg border-none"
                            />
                        </div>
                    </div>

                    <button 
                        onClick={handleSave}
                        className="w-full py-4 bg-gray-900 text-white rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform"
                    >
                        Á¢∫Ë™çÂÑ≤Â≠ò
                    </button>
                </div>
            );
        };

        // 4.2 Â†±Ë°®È†ÅÈù¢
        const ReportView = ({ transactions }) => {
            const currentMonth = new Date().toISOString().slice(0, 7);
            const [monthFilter, setMonthFilter] = useState(currentMonth);

            const filteredTx = useMemo(() => {
                return transactions.filter(t => t.date.startsWith(monthFilter));
            }, [transactions, monthFilter]);

            const handleExportCSV = () => {
                const headers = ['Êó•Êúü', 'Ê≠∏Â±¨Â∞çË±°(Â∫óÈã™)', 'Êî∂ÊîØÈ°ûÂûã', 'ÈáëÈ°ç', 'ÂàÜÈ°û', 'Â∏≥Êà∂', 'ÂÇôË®ª'];
                const rows = filteredTx.map(t => [
                    t.date,
                    getShopName(t.shopId),
                    t.type === 'income' ? 'Êî∂ÂÖ•' : 'ÊîØÂá∫',
                    t.amount,
                    t.category,
                    getAccountName(t.accountId),
                    t.note || ''
                ]);

                const csvContent = [
                    '\uFEFF' + headers.join(','),
                    ...rows.map(row => row.map(item => `"${item}"`).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `Ë≤°ÂãôÂ†±Ë°®_${monthFilter}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const reportData = SHOPS.map(shop => {
                const shopTx = filteredTx.filter(t => t.shopId === shop.id);
                const income = shopTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expense = shopTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                return { ...shop, income, expense, profit: income - expense };
            });

            const totalAdvanced = filteredTx
                .filter(t => t.type === 'expense' && t.shopId !== 'family' && isPersonalAccount(t.accountId))
                .reduce((sum, t) => sum + t.amount, 0);

            const totalPersonalExpense = filteredTx
                .filter(t => t.type === 'expense' && t.shopId === 'family')
                .reduce((sum, t) => sum + t.amount, 0);

            return (
                <div className="p-4 pb-24 max-w-md mx-auto bg-gray-50 min-h-screen">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-bold text-gray-800 flex items-center">
                            <PieChart className="w-6 h-6 mr-2 text-purple-600" /> ÊêçÁõäÂ†±Ë°®
                        </h2>
                        <div className="flex gap-2">
                            <input 
                                type="month" 
                                value={monthFilter}
                                onChange={e => setMonthFilter(e.target.value)}
                                className="text-sm bg-white border border-gray-300 rounded px-2 py-1 w-32"
                            />
                            <button 
                                onClick={handleExportCSV}
                                className="bg-blue-600 text-white p-1.5 rounded shadow-sm hover:bg-blue-700 active:scale-95"
                                title="‰∏ãËºâÊú¨ÊúàÂ†±Ë°®"
                            >
                                <Download size={20} />
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-3 mb-6">
                        <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500 relative overflow-hidden">
                            <div className="absolute right-0 top-0 p-1 opacity-10"><Wallet size={40}/></div>
                            <div className="text-gray-500 text-xs font-bold mb-1">Êú¨ÊúàÂ¶≥ÂÖàÂ¢äÁöÑÈå¢</div>
                            <div className="text-xl font-bold text-red-600">${totalAdvanced.toLocaleString()}</div>
                            <div className="text-[10px] text-gray-400 mt-1">ÊúàÂ∫ïË®òÂæóÂæûÂÖ¨Âè∏ËΩâÂõûÁµ¶Ëá™Â∑±</div>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-400">
                            <div className="text-gray-500 text-xs font-bold mb-1">Êú¨ÊúàÂÆ∂Áî®/ÂÄã‰∫∫Ëä±Ë≤ª</div>
                            <div className="text-xl font-bold text-gray-900">${totalPersonalExpense.toLocaleString()}</div>
                        </div>
                    </div>

                    <h3 className="text-sm font-bold text-gray-600 mb-3 px-1">ÂêÑÂ∫óÊú¨ÊúàÊêçÁõä (Ë≥∫ - Ë≥†)</h3>
                    <div className="space-y-3">
                        {reportData.map(shop => (
                            <div key={shop.id} className="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center">
                                <div className="flex items-center">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center mr-3 ${shop.color}`}>
                                        {shop.id === 'family' ? <Home size={18}/> : <Building2 size={18}/>}
                                    </div>
                                    <div>
                                        <div className="font-bold text-gray-800">{shop.name}</div>
                                        <div className="text-[10px] text-gray-400">
                                            Êî∂ ${shop.income.toLocaleString()} / ÊîØ ${shop.expense.toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                                <div className={`text-right font-bold ${shop.profit >= 0 ? 'text-green-600' : 'text-red-500'}`}>
                                    {shop.profit >= 0 ? '+' : ''}{shop.profit.toLocaleString()}
                                    <div className="text-[10px] font-normal text-gray-400">Ê∑®Âà©</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // 4.3 ÊòéÁ¥∞È†ÅÈù¢
        const ListView = ({ transactions, handleDelete }) => {
            const [filterShop, setFilterShop] = useState('all');

            const displayTx = transactions
                .filter(t => filterShop === 'all' || t.shopId === filterShop)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            return (
                <div className="p-4 pb-24 max-w-md mx-auto">
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center justify-between">
                        <span className="flex items-center"><ListIcon className="w-6 h-6 mr-2 text-green-600" /> Â∏≥ÂãôÊòéÁ¥∞</span>
                        <select 
                            className="text-sm border rounded p-1"
                            value={filterShop}
                            onChange={e => setFilterShop(e.target.value)}
                        >
                            <option value="all">ÂÖ®ÈÉ®Â∫óÈã™</option>
                            {SHOPS.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                        </select>
                    </h2>

                    <div className="space-y-2">
                        {displayTx.length === 0 && <div className="text-center text-gray-400 py-10">Â∞öÁÑ°Ë≥áÊñô</div>}
                        {displayTx.map(tx => {
                            const shop = SHOPS.find(s => s.id === tx.shopId);
                            const isPersonal = isPersonalAccount(tx.accountId);
                            return (
                                <div key={tx.id} className="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <div className={`text-xs font-bold px-2 py-1 rounded ${shop?.color}`}>
                                            {shop?.name.slice(0, 2)}
                                        </div>
                                        <div>
                                            <div className="font-bold text-gray-800 text-sm flex items-center gap-2">
                                                {tx.category}
                                                <span className={`text-[10px] px-1.5 py-0.5 rounded border ${isPersonal ? 'bg-amber-50 text-amber-700 border-amber-200' : 'bg-gray-50 text-gray-500 border-gray-200'}`}>
                                                    {getAccountName(tx.accountId)}
                                                </span>
                                            </div>
                                            <div className="text-xs text-gray-400">{tx.date} {tx.note && `‚Ä¢ ${tx.note}`}</div>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <span className={`font-bold ${tx.type === 'income' ? 'text-green-600' : 'text-red-500'}`}>
                                            {tx.type === 'income' ? '+' : '-'}${tx.amount.toLocaleString()}
                                        </span>
                                        <button onClick={() => handleDelete(tx.id)} className="text-gray-300 hover:text-red-500">
                                            <Trash2 size={16} />
                                        </button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- 5. ‰∏ªÁ®ãÂºè App ---
        function App() {
            const [view, setView] = useState('add');
            const [transactions, setTransactions] = useState(() => {
                const saved = localStorage.getItem('boss_finance_data_v3'); // Âª∂Á∫å‰ΩøÁî® v3 ÁöÑË≥áÊñôÂ∫´
                return saved ? JSON.parse(saved) : [];
            });

            // Form State
            const [date, setDate] = useState(new Date().toISOString().slice(0, 10));
            const [selectedShop, setSelectedShop] = useState(SHOPS[0].id);
            const [type, setType] = useState('expense');
            const [amount, setAmount] = useState('');
            const [category, setCategory] = useState('');
            const [accountId, setAccountId] = useState('my_cash'); 
            const [note, setNote] = useState('');

            useEffect(() => {
                localStorage.setItem('boss_finance_data_v3', JSON.stringify(transactions));
            }, [transactions]);

            const currentShopType = SHOPS.find(s => s.id === selectedShop)?.type || 'business';
            const availableCategories = useMemo(() => currentShopType === 'business' 
                ? (type === 'expense' ? CATEGORIES.business_expense : CATEGORIES.business_income)
                : (type === 'expense' ? CATEGORIES.personal_expense : CATEGORIES.personal_income), [currentShopType, type]);

            useEffect(() => {
                setCategory(availableCategories[0]);
            }, [type, selectedShop, currentShopType]); // ÈÄôË£°ÊãøÊéâ availableCategories dependency ÈÅøÂÖç loop

            const handleSave = () => {
                if (!amount) return alert('Ë´ãËº∏ÂÖ•ÈáëÈ°ç');
                
                const newTx = {
                    id: Date.now(),
                    date,
                    shopId: selectedShop,
                    type,
                    amount: parseFloat(amount),
                    category,
                    accountId,
                    note,
                };

                setTransactions([newTx, ...transactions]);
                setAmount('');
                setNote('');
                alert('Â∑≤Ë®òÈåÑÔºÅ');
            };

            const handleDelete = (id) => {
                if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÁ¥ÄÈåÑÂóéÔºü')) {
                    setTransactions(transactions.filter(t => t.id !== id));
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-900">
                    {view === 'add' && <AddView 
                        date={date} setDate={setDate}
                        selectedShop={selectedShop} setSelectedShop={setSelectedShop}
                        type={type} setType={setType}
                        amount={amount} setAmount={setAmount}
                        category={category} setCategory={setCategory}
                        accountId={accountId} setAccountId={setAccountId}
                        note={note} setNote={setNote}
                        handleSave={handleSave}
                        availableCategories={availableCategories}
                    />}
                    
                    {view === 'list' && <ListView transactions={transactions} handleDelete={handleDelete} />}
                    
                    {view === 'report' && <ReportView transactions={transactions} />}

                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3 flex justify-between items-center pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-50">
                        <button onClick={() => setView('add')} className={`flex flex-col items-center space-y-1 ${view === 'add' ? 'text-blue-600' : 'text-gray-400'}`}>
                            <div className={`p-1 rounded-full ${view === 'add' ? 'bg-blue-50' : ''}`}><Plus size={24} strokeWidth={2.5} /></div>
                            <span className="text-[10px] font-bold">Ë®òÂ∏≥</span>
                        </button>
                        <button onClick={() => setView('list')} className={`flex flex-col items-center space-y-1 ${view === 'list' ? 'text-blue-600' : 'text-gray-400'}`}>
                            <ListIcon size={24} strokeWidth={2.5} />
                            <span className="text-[10px] font-bold">ÊòéÁ¥∞</span>
                        </button>
                        <button onClick={() => setView('report')} className={`flex flex-col items-center space-y-1 ${view === 'report' ? 'text-blue-600' : 'text-gray-400'}`}>
                            <PieChart size={24} strokeWidth={2.5} />
                            <span className="text-[10px] font-bold">Â†±Ë°®</span>
                        </button>
                    </div>
                    <div className="h-20"></div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

