<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡ƒåœ’é—†å¨˜éº»å°‡æ¨æ¨</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map: å‘Šè¨´ç€è¦½å™¨å¦‚ä½•è™•ç† import -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <style>
        /* è‡ªå®šç¾©éº»å°‡é¢¨æ ¼å‹•ç•« */
        @keyframes shuffle {
            0% { transform: translateY(0) rotate(0); }
            25% { transform: translateY(-5px) rotate(-5deg); }
            50% { transform: translateY(0) rotate(0); }
            75% { transform: translateY(-5px) rotate(5deg); }
            100% { transform: translateY(0) rotate(0); }
        }
        .animate-shuffle {
            animation: shuffle 0.5s ease-in-out infinite;
        }
        
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-green-900 text-white select-none">
<script>
        // å°‡ä½ åœ¨ç¬¬ä¸€æ­¥è¤‡è£½çš„å…§å®¹å¡«å…¥ä¸‹æ–¹å¼•è™Ÿä¸­
        window.__firebase_config = JSON.stringify({
          apiKey: "AIzaSyD1wL8HJo5ca1S9FDyN1dvTpbZgGi2tpF4",
    authDomain: "mj-a6496.firebaseapp.com",
    projectId: "mj-a6496",
    storageBucket: "mj-a6496.firebasestorage.app",
    messagingSenderId: "131448365662",
    appId: "1:131448365662:web:c78f80158b3c6b39c88acf",
    measurementId: "G-RCK1DB2ZNS"
        });
        
        // è¨­å®š App ID (å°æ‡‰è³‡æ–™åº«è·¯å¾‘ artifacts/93MJ/...)
        window.__app_id = "93MJ"; 
    </script>   
 <div id="root"></div>




    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            getDocs, 
            orderBy, 
            serverTimestamp,
            updateDoc,
            doc
        } from 'firebase/firestore';
        import { Gift, Calendar, User, FileSpreadsheet, Smartphone, Home, KeyRound, MapPin, CheckCircle2, Clock } from 'lucide-react';

        // --- Firebase Configuration ---
        // å˜—è©¦è®€å–ç’°å¢ƒè®Šæ•¸ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ç©ºç‰©ä»¶é¿å…å ±éŒ¯ï¼ˆå¯¦éš›é‹è¡Œæ™‚éœ€æœ‰ç’°å¢ƒè®Šæ•¸ï¼‰
        const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const firebaseConfig = JSON.parse(firebaseConfigRaw);
        
        // åˆå§‹åŒ– Firebase (åƒ…åœ¨é…ç½®å­˜åœ¨æ™‚)
        let app, auth, db;
        try {
            if (firebaseConfig.apiKey) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (e) {
            console.error("Firebase init error:", e);
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Data Constants ---
        const BRANCH_DATA = {
            'å¤§æ—åº—': ['å—', 'è¥¿', 'åŒ—', 'ä¸­', 'ç™¼', 'ç™½'],
            'å…«å¾·åº—': ['æ¢…', 'è˜­', 'ç«¹', 'èŠ', 'æ˜¥', 'å¤', 'ç§‹', 'å†¬', 'è½‰é‹', 'æ”¹é‹'],
            'å—å´åº—': ['1æ¢', '2æ¢', '3æ¢', '4æ¢', '5æ¢', '6æ¢', '7æ¢'],
            'è‰æ¼¯åº—': ['1ç­’', '2ç­’', '3ç­’', '4ç­’', '5ç­’', '6ç­’'],
            'æ¥Šæ¢…åº—': ['åº·', 'è²¡', 'ç¦', 'ç¥¿', 'å£½', 'å–œ', 'é †', 'å®‰', 'æ—º'],
            'ä¸­å’Œä¸­æ­£åº—': ['å£¹', 'è²³', 'åƒ', 'è‚†', 'ä¼', 'é™¸', 'æŸ’', 'æŒ', 'ç–', 'æ‹¾']
        };

        // --- Helpers ---
        const formatDate = (date) => {
            if (!date) return '';
            const d = new Date(date);
            return `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        };

        const getRewardDeadline = (bookingDateStr) => {
            if (!bookingDateStr) return '';
            const bookingDate = new Date(bookingDateStr);
            const nextDay = new Date(bookingDate);
            nextDay.setDate(bookingDate.getDate() + 1);
            return `${nextDay.getMonth() + 1}/${nextDay.getDate()} 23:59`;
        };

        // --- Components ---

        // 1. Loading Spinner
        const LoadingSpinner = () => (
            <div className="flex flex-col justify-center items-center h-screen bg-green-900">
                <div className="text-6xl animate-bounce mb-4">ğŸ€„</div>
                <div className="flex items-center gap-2">
                    <div className="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div>
                    <div className="w-3 h-3 bg-yellow-400 rounded-full animate-pulse delay-75"></div>
                    <div className="w-3 h-3 bg-yellow-400 rounded-full animate-pulse delay-150"></div>
                </div>
                <span className="mt-3 text-yellow-400 font-bold text-lg tracking-widest">æ´—ç‰Œä¸­...</span>
            </div>
        );

        // 2. Admin Login Modal
        const AdminLogin = ({ onLogin, onCancel }) => {
            const [pass, setPass] = useState('');
            
            const handleLogin = () => {
                if (pass === '88881349') { 
                    onLogin();
                } else {
                    alert('å¯†ç¢¼éŒ¯èª¤ï¼ç›¸å…¬äº†ï¼');
                }
            };

            return (
                <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-red-900 border-4 border-yellow-500 rounded-xl p-8 w-full max-w-sm text-center shadow-[0_0_30px_rgba(234,179,8,0.3)]">
                        <h3 className="text-2xl font-black text-yellow-400 mb-6 flex items-center justify-center gap-2">
                            <KeyRound className="w-8 h-8" /> èŠå®¶ç™»å…¥
                        </h3>
                        <input 
                            type="password" 
                            value={pass}
                            onChange={(e) => setPass(e.target.value)}
                            placeholder="è«‹è¼¸å…¥èŠå®¶å¯†ç¢¼ "
                            className="w-full p-4 rounded-lg bg-red-950 border-2 border-yellow-600/50 text-white placeholder-red-400/50 mb-6 text-center text-xl tracking-widest focus:border-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-400/20 transition-all"
                            autoFocus
                        />
                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 py-3 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 font-bold transition-colors">å–æ¶ˆ</button>
                            <button onClick={handleLogin} className="flex-1 py-3 bg-gradient-to-r from-yellow-500 to-yellow-600 text-red-900 font-black rounded-lg hover:from-yellow-400 hover:to-yellow-500 shadow-lg transform hover:-translate-y-0.5 transition-all">ç¢ºèª</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. User Form (Main Page)
        const UserForm = ({ onSubmit, isSubmitting }) => {
            const [formData, setFormData] = useState({
                phone: '',
                bookingDate: '',
                branch: '',
                roomName: '',
                inviteCode: ''
            });

            const [availableRooms, setAvailableRooms] = useState([]);

            const handleBranchChange = (e) => {
                const selectedBranch = e.target.value;
                setFormData({
                    ...formData,
                    branch: selectedBranch,
                    roomName: ''
                });
                setAvailableRooms(BRANCH_DATA[selectedBranch] || []);
            };

            const handleChange = (e) => {
                setFormData({ ...formData, [e.target.name]: e.target.value });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.phone || !formData.bookingDate || !formData.branch || !formData.roomName || !formData.inviteCode) {
                    alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼Œæ‰èƒ½è½ç‰Œå–”ï¼');
                    return;
                }
                onSubmit(formData);
            };

            // Calculate today for date picker min value
            const today = new Date().toISOString().split('T')[0];

            return (
                <div className="w-full max-w-md mx-auto pb-20">
                    {/* Header */}
                    <div className="text-center mb-8 pt-4">
                        <div className="inline-block relative">
                            <div className="absolute inset-0 bg-yellow-500 blur-lg opacity-20 rounded-full"></div>
                            <div className="relative bg-gradient-to-r from-red-800 to-red-900 text-yellow-400 border-y-4 border-yellow-500 px-8 py-3 rounded-lg shadow-2xl transform -rotate-1">
                                <h1 className="text-3xl font-black tracking-[0.2em] drop-shadow-md">ğŸ€„ æ¡ƒåœ’é—†å¨˜éº»å°‡é¤¨ </h1>
                            </div>
                        </div>
                        <p className="text-green-200/80 mt-4 font-medium text-sm tracking-wide">
                            å¡«å¯«è³‡æ–™ â€¢ ç´¯ç©æ¬¡æ•¸ â€¢ é ˜å–å„ªæƒ 
                        </p>
                    </div>

                    {/* Form Card */}
                    <div className="bg-white/5 backdrop-blur-xl border border-yellow-500/30 rounded-2xl p-6 shadow-2xl relative overflow-hidden mx-4">
                        {/* Decorative Background Char */}
                        <div className="absolute -top-12 -right-12 text-[10rem] opacity-5 text-yellow-100 font-serif rotate-12 select-none pointer-events-none">ç™¼</div>
                        
                        <form onSubmit={handleSubmit} className="space-y-5 relative z-10">
                            
                            <div className="space-y-1.5">
                                <label className="text-yellow-200 text-sm font-bold flex items-center gap-2">
                                    <Smartphone className="w-4 h-4 text-yellow-500"/> æœƒå“¡é›»è©± <span className="text-green-400/60 text-xs font-normal">(ç´¯ç©åæ¬¡æœ‰å¤§ç)</span>
                                </label>
                                <input
                                    type="tel"
                                    name="phone"
                                    value={formData.phone}
                                    onChange={handleChange}
                                    placeholder="0912345678"
                                    className="w-full p-3.5 rounded-xl bg-black/20 border border-yellow-600/30 text-white placeholder-white/20 focus:outline-none focus:ring-2 focus:ring-yellow-500/50 focus:border-yellow-500 transition-all font-mono text-lg tracking-wider"
                                />
                            </div>

                            <div className="space-y-1.5">
                                <label className="text-yellow-200 text-sm font-bold flex items-center gap-2">
                                    <Calendar className="w-4 h-4 text-yellow-500"/> é ç´„æ—¥æœŸ
                                </label>
                                <input
                                    type="date"
                                    name="bookingDate"
                                    min={today}
                                    value={formData.bookingDate}
                                    onChange={handleChange}
                                    className="w-full p-3.5 rounded-xl bg-black/20 border border-yellow-600/30 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500/50 focus:border-yellow-500 transition-all"
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-1.5">
                                    <label className="text-yellow-200 text-sm font-bold flex items-center gap-2">
                                        <MapPin className="w-4 h-4 text-yellow-500"/> åˆ†åº—
                                    </label>
                                    <select
                                        name="branch"
                                        value={formData.branch}
                                        onChange={handleBranchChange}
                                        className="w-full p-3.5 rounded-xl bg-black/20 border border-yellow-600/30 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500/50 focus:border-yellow-500 transition-all appearance-none"
                                        style={{backgroundImage: 'none'}} 
                                    >
                                        <option value="" className="bg-gray-800 text-gray-400">é¸æ“‡</option>
                                        {Object.keys(BRANCH_DATA).map(branch => (
                                            <option key={branch} value={branch} className="bg-gray-800">{branch}</option>
                                        ))}
                                    </select>
                                </div>

                                <div className="space-y-1.5">
                                    <label className="text-yellow-200 text-sm font-bold flex items-center gap-2">
                                        <Home className="w-4 h-4 text-yellow-500"/> åŒ…å»‚
                                    </label>
                                    <select
                                        name="roomName"
                                        value={formData.roomName}
                                        onChange={handleChange}
                                        disabled={!formData.branch}
                                        className="w-full p-3.5 rounded-xl bg-black/20 border border-yellow-600/30 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500/50 focus:border-yellow-500 transition-all appearance-none disabled:opacity-50"
                                    >
                                        <option value="" className="bg-gray-800">é¸æ“‡</option>
                                        {availableRooms.map(room => (
                                            <option key={room} value={room} className="bg-gray-800">{room}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            <div className="space-y-1.5">
                                <label className="text-yellow-200 text-sm font-bold flex items-center gap-2">
                                    <User className="w-4 h-4 text-yellow-500"/> æ¨å»£è€…é‚€è«‹ç¢¼
                                </label>
                                <input
                                    type="text"
                                    name="inviteCode"
                                    value={formData.inviteCode}
                                    onChange={handleChange}
                                    placeholder="è¼¸å…¥ä»£ç¢¼"
pattern="X4V2026|x4v2026|93M2026|9MM2026"
title="è«‹è¼¸å…¥æ­£ç¢ºçš„é‚€è«‹ç¢¼ (ä¾‹å¦‚ï¼šVIP8888)"
                                    className="w-full p-3.5 rounded-xl bg-black/20 border border-yellow-600/30 text-white placeholder-white/20 focus:outline-none focus:ring-2 focus:ring-yellow-500/50 focus:border-yellow-500 transition-all text-center tracking-widest uppercase"
                              required  />
                            </div>

                            <button
                                disabled={isSubmitting}
                                type="submit"
                                className="w-full mt-8 bg-gradient-to-b from-yellow-300 via-yellow-500 to-yellow-600 text-red-950 font-black text-xl py-4 rounded-xl shadow-[0_4px_0_rgb(146,64,14)] hover:brightness-110 hover:shadow-[0_6px_0_rgb(146,64,14)] hover:-translate-y-0.5 active:shadow-[0_0_0_rgb(146,64,14)] active:translate-y-1 transition-all flex items-center justify-center gap-3 group"
                            >
                                {isSubmitting ? (
                                    <span className="flex items-center gap-2"><span className="animate-spin">âŸ³</span> è™•ç†ä¸­...</span>
                                ) : (
                                    <>
                                        <span className="text-2xl group-hover:rotate-12 transition-transform">ğŸ²</span>
                                        ç«‹å³é€å‡º
                                        <span className="text-2xl group-hover:-rotate-12 transition-transform">ğŸ²</span>
                                    </>
                                )}
                            </button>

                        </form>
                    </div>
                </div>
            );
        };

        // 4. Success Screen
        const SuccessScreen = ({ result, onReset }) => {
            const isBigPrize = result.isMilestone; // 10th time

            return (
                <div className="w-full h-full flex items-center justify-center p-4">
                    <div className="text-center w-full max-w-sm mx-auto animate-[fade-in_0.5s_ease-out]">
                        
                        {/* Success Card */}
                        <div className="bg-gradient-to-b from-red-900 to-red-950 border-4 border-yellow-500 p-8 rounded-3xl shadow-2xl relative overflow-visible">
                            
                            {/* Confetti/Badge */}
                            <div className="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-yellow-400 to-yellow-600 text-red-900 px-8 py-2 rounded-full font-black shadow-[0_4px_10px_rgba(0,0,0,0.5)] whitespace-nowrap border-2 border-yellow-200 z-20">
                                {isBigPrize ? 'ğŸ‰ æ­å–œç™¼è²¡ï¼å¤§çèƒ¡äº†ï¼' : 'ğŸ‰ ç™»è¨˜æˆåŠŸ ğŸ‰'}
                            </div>

                            {/* Main Content */}
                            <div className="mt-8 mb-6 relative z-10">
                                <div className={`text-8xl mb-4 filter drop-shadow-lg transform transition-transform hover:scale-110 duration-300 cursor-default ${isBigPrize ? 'animate-bounce' : ''}`}>
                                    {isBigPrize ? 'ğŸ€…' : 'ğŸ€„'}
                                </div>
                                
                                <h2 className="text-2xl font-bold text-yellow-300 mb-2">
                                    ç´¯ç©ç¬¬ <span className="text-5xl font-black text-white drop-shadow-md mx-1">{result.currentCount}</span> æ¬¡
                                </h2>
                                <p className="text-red-200/60 font-mono tracking-wider">{result.phone}</p>
                            </div>

                            {/* Ticket Visual */}
                            <div className="bg-black/40 p-1 rounded-2xl mb-8 border border-yellow-500/30 relative group">
                                <div className="absolute inset-0 bg-yellow-500/10 blur-xl group-hover:bg-yellow-500/20 transition-all"></div>
                                <div className="border border-dashed border-white/20 rounded-xl p-5 relative overflow-hidden">
                                    <div className="absolute -left-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-red-900 rounded-full"></div>
                                    <div className="absolute -right-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-red-900 rounded-full"></div>
                                    
                                    <p className="text-green-300 text-xs mb-2 flex items-center justify-center gap-1">
                                        <Clock size={12}/>
                                        ç™¼é€æœŸé™ï¼š<span className="text-yellow-400 font-bold">{getRewardDeadline(result.bookingDate)}</span>
                                    </p>
                                    <p className={`text-2xl font-black ${isBigPrize ? 'text-yellow-400' : 'text-white'}`}>
                                        {isBigPrize ? 'ğŸ 2å°æ™‚ å¸¸å®¢çºŒæ™‚åˆ¸' : 'ğŸŸï¸ 1å°æ™‚ å…è²»çºŒæ™‚åˆ¸'}
                                    </p>
                                </div>
                            </div>

                            <button 
                                onClick={onReset}
                                className="w-full py-4 bg-transparent border-2 border-yellow-500/50 text-yellow-500 font-bold rounded-xl hover:bg-yellow-500 hover:text-red-900 hover:border-yellow-500 transition-all active:scale-95 flex items-center justify-center gap-2"
                            >
                                <CheckCircle2 size={20}/>
                                å®Œæˆä¸¦è¿”å›
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 5. Admin Dashboard
        const AdminDashboard = ({ data, onClose, onToggleStatus }) => {
            
            const downloadCSV = () => {
                const headers = ["ç™»éŒ„æ™‚é–“", "æœƒå“¡é›»è©±", "é ç´„æ—¥æœŸ", "åˆ†åº—", "åŒ…å»‚åç¨±", "é‚€è«‹ç¢¼", "ç´¯ç©æ¬¡æ•¸", "çå‹µé¡å‹", "æ˜¯å¦å·²ç™¼åˆ¸"];
                const csvContent = [
                    headers.join(","),
                    ...data.map(item => [
                        formatDate(item.timestamp?.toDate()),
                        item.phone,
                        item.bookingDate,
                        item.branch,
                        item.roomName,
                        item.inviteCode,
                        item.accumulatedCount,
                        item.accumulatedCount % 10 === 0 ? "2å°æ™‚å¸¸å®¢åˆ¸" : "1å°æ™‚å…è²»åˆ¸",
                        item.isSent ? "æ˜¯" : "å¦"
                    ].join(","))
                ].join("\n");

                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `éº»å°‡æ¨å»£å ±è¡¨_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            };

            return (
                <div className="fixed inset-0 bg-gray-50 z-50 overflow-hidden flex flex-col text-gray-800 font-sans">
                    {/* Toolbar */}
                    <div className="bg-white px-6 py-4 shadow-md flex flex-col md:flex-row justify-between items-center gap-4 z-10 border-b border-gray-200">
                        <div className="flex items-center gap-3">
                            <div className="bg-green-100 p-2 rounded-lg">
                                <FileSpreadsheet className="text-green-600 w-6 h-6"/>
                            </div>
                            <div>
                                <h2 className="text-xl font-bold text-gray-800">å¾Œå°æ•¸æ“šä¸­å¿ƒ</h2>
                                <p className="text-xs text-gray-500">å…± {data.length} ç­†è³‡æ–™</p>
                            </div>
                        </div>
                        <div className="flex gap-3 w-full md:w-auto">
                            <button onClick={downloadCSV} className="flex-1 md:flex-none bg-green-600 text-white px-5 py-2.5 rounded-lg hover:bg-green-700 font-bold flex items-center justify-center gap-2 shadow-sm transition-colors text-sm">
                                åŒ¯å‡º Excel
                            </button>
                            <button onClick={onClose} className="flex-1 md:flex-none bg-gray-800 text-white px-5 py-2.5 rounded-lg hover:bg-gray-900 font-medium shadow-sm transition-colors text-sm">
                                è¿”å›å‰å°
                            </button>
                        </div>
                    </div>

                    {/* Table Area */}
                    <div className="flex-grow overflow-auto bg-gray-50 p-4 md:p-8">
                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left whitespace-nowrap">
                                    <thead className="bg-gray-50 text-gray-500 uppercase text-xs font-semibold tracking-wider">
                                        <tr>
                                            <th className="px-6 py-4 border-b">ç™»éŒ„æ™‚é–“</th>
                                            <th className="px-6 py-4 border-b">æœƒå“¡é›»è©±</th>
                                            <th className="px-6 py-4 border-b">é ç´„è³‡è¨Š</th>
                                            <th className="px-6 py-4 border-b">é‚€è«‹ç¢¼</th>
                                            <th className="px-6 py-4 border-b text-center">ç´¯ç©æ¬¡æ•¸</th>
                                            <th className="px-6 py-4 border-b">æ‡‰ç™¼çå‹µ</th>
                                            <th className="px-6 py-4 border-b text-center">ç‹€æ…‹æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {data.map((row) => {
                                            const isBigReward = row.accumulatedCount % 10 === 0;
                                            return (
                                                <tr key={row.id} className="hover:bg-blue-50/50 transition-colors group">
                                                    <td className="px-6 py-4 text-gray-500">
                                                        {formatDate(row.timestamp?.toDate())}
                                                    </td>
                                                    <td className="px-6 py-4 font-mono font-medium text-gray-900">
                                                        {row.phone}
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <div className="flex flex-col">
                                                            <span className="font-bold text-gray-800">{row.branch}</span>
                                                            <div className="text-xs text-gray-500 flex items-center gap-1 mt-0.5">
                                                                <span className="bg-gray-100 px-1.5 py-0.5 rounded text-gray-600">{row.roomName}</span>
                                                                <span>â€¢ {row.bookingDate}</span>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <span className="bg-indigo-50 text-indigo-700 px-2 py-1 rounded border border-indigo-100 font-mono text-xs">
                                                            {row.inviteCode}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4 text-center">
                                                        <span className="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 font-bold text-gray-700">
                                                            {row.accumulatedCount}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        {isBigReward ? (
                                                            <span className="inline-flex items-center gap-1.5 text-red-600 font-bold bg-red-50 px-2.5 py-1 rounded-full text-xs border border-red-100">
                                                                <Gift size={14}/> 2å°æ™‚å¸¸å®¢åˆ¸
                                                            </span>
                                                        ) : (
                                                            <span className="inline-flex items-center gap-1.5 text-gray-600 bg-gray-100 px-2.5 py-1 rounded-full text-xs">
                                                                1å°æ™‚å…è²»åˆ¸
                                                            </span>
                                                        )}
                                                    </td>
                                                    <td className="px-6 py-4 text-center">
                                                        <button 
                                                            onClick={() => onToggleStatus(row.id, row.isSent)}
                                                            className={`px-4 py-1.5 rounded-full text-xs font-bold transition-all shadow-sm ${
                                                                row.isSent 
                                                                ? 'bg-green-100 text-green-700 border border-green-200 hover:bg-green-200' 
                                                                : 'bg-white text-gray-500 border border-gray-300 hover:border-blue-400 hover:text-blue-500'
                                                            }`}
                                                        >
                                                            {row.isSent ? 'å·²ç™¼é€' : 'æ¨™è¨˜ç™¼é€'}
                                                        </button>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                        {data.length === 0 && (
                                            <tr>
                                                <td colSpan="8" className="text-center py-12 text-gray-400 flex flex-col items-center">
                                                    <div className="text-4xl mb-2 opacity-20">ğŸ€„</div>
                                                    ç›®å‰å°šç„¡è³‡æ–™
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('form'); // 'form', 'success', 'admin'
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [lastResult, setLastResult] = useState(null);
            const [adminData, setAdminData] = useState([]);
            const [showLogin, setShowLogin] = useState(false);
            const [isInit, setIsInit] = useState(true);

            // Auth & Init
            useEffect(() => {
                const initAuth = async () => {
                    if (!auth) return; // Firebase init failed
                    
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth failed", err);
                    }
                };

                initAuth();
                
                if (auth) {
                    return onAuthStateChanged(auth, (u) => {
                        setUser(u);
                        setIsInit(false);
                    });
                } else {
                    setIsInit(false);
                }
            }, []);

            // Submit Logic
            const handleUserSubmit = async (formData) => {
                if (!user || !db) {
                     alert("ç³»çµ±æœªé€£æ¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
                     return;
                }
                setIsSubmitting(true);

                try {
                    // 1. Calculate count for this phone number
                    const q = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'referrals'),
                        where('phone', '==', formData.phone)
                    );
                    
                    const querySnapshot = await getDocs(q);
                    const currentCount = querySnapshot.size + 1;

                    // 2. Determine Reward
                    const isMilestone = currentCount > 0 && currentCount % 10 === 0;

                    // 3. Save to DB
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'referrals'), {
                        ...formData,
                        accumulatedCount: currentCount,
                        isSent: false,
                        timestamp: serverTimestamp(),
                        userId: user.uid
                    });

                    // 4. Show Success
                    setLastResult({
                        phone: formData.phone,
                        bookingDate: formData.bookingDate, 
                        currentCount,
                        isMilestone
                    });
                    setView('success');

                } catch (error) {
                    console.error("Error submitting:", error);
                    alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
                } finally {
                    setIsSubmitting(false);
                }
            };

            // Fetch Admin Data
            const fetchAdminData = async () => {
                if (!user || !db) return;
                try {
                    const q = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'referrals'),
                        orderBy('timestamp', 'desc')
                    );
                    const snapshot = await getDocs(q);
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setAdminData(data);
                    setView('admin');
                    setShowLogin(false);
                } catch (e) {
                    console.error("Fetch error, trying fallback:", e);
                    // Fallback client-side sort if index missing
                    const qFallback = query(collection(db, 'artifacts', appId, 'public', 'data', 'referrals'));
                    const snapshot = await getDocs(qFallback);
                    const data = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    setAdminData(data);
                    setView('admin');
                    setShowLogin(false);
                }
            };

            // Toggle Sent Status
            const toggleStatus = async (docId, currentStatus) => {
                try {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'referrals', docId);
                    await updateDoc(ref, { isSent: !currentStatus });
                    setAdminData(prev => prev.map(item => 
                        item.id === docId ? { ...item, isSent: !currentStatus } : item
                    ));
                } catch (e) {
                    console.error("Update error:", e);
                    alert("æ›´æ–°ç‹€æ…‹å¤±æ•—");
                }
            };

            if (isInit) return <LoadingSpinner/>;

            return (
                <div className="min-h-screen bg-[#1a472a] font-sans text-white relative flex flex-col overflow-hidden">
                    {/* Background Pattern */}
                    <div className="absolute inset-0 opacity-10 pointer-events-none" style={{
                        backgroundImage: `radial-gradient(circle, #facc15 1px, transparent 1px)`,
                        backgroundSize: '30px 30px'
                    }}></div>
                    
                    {/* Glowing Orbs */}
                    <div className="absolute top-0 left-0 w-64 h-64 bg-yellow-500 rounded-full mix-blend-overlay filter blur-[100px] opacity-20 animate-pulse"></div>
                    <div className="absolute bottom-0 right-0 w-96 h-96 bg-red-600 rounded-full mix-blend-overlay filter blur-[120px] opacity-20 animate-pulse delay-1000"></div>

                    <div className="flex-grow flex items-center justify-center relative z-10 w-full">
                        
                        {view === 'form' && (
                            <UserForm onSubmit={handleUserSubmit} isSubmitting={isSubmitting} />
                        )}

                        {view === 'success' && lastResult && (
                            <SuccessScreen result={lastResult} onReset={() => setView('form')} />
                        )}

                        {view === 'admin' && (
                            <AdminDashboard 
                                data={adminData} 
                                onClose={() => setView('form')} 
                                onToggleStatus={toggleStatus}
                            />
                        )}

                    </div>

                    {/* Footer / Admin Trigger */}
                    {view !== 'admin' && (
                        <div className="fixed bottom-0 w-full p-4 text-center z-20 pointer-events-none">
                            <div className="pointer-events-auto inline-block">
                                <button 
                                    onClick={() => setShowLogin(true)}
                                    className="text-green-800/40 hover:text-yellow-500/80 transition-colors text-3xl transform hover:scale-110 active:scale-95 duration-200"
                                    title="ç®¡ç†å“¡ç™»å…¥"
                                >
                                    ğŸ€„
                                </button>
                                <p className="text-[10px] text-green-800/30 mt-1 font-serif tracking-widest">SYSTEM VER 1.0</p>
                            </div>
                        </div>
                    )}

                    {/* Login Modal */}
                    {showLogin && (
                        <AdminLogin onLogin={fetchAdminData} onCancel={() => setShowLogin(false)} />
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>





